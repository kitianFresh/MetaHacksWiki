<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>unix-process-thread - MetaHacks Wiki</title>
    <meta name="keywords" content="wiki, simiki, computer, cognitive,"/>
    <meta name="description" content="my personal wiki"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#java">java</a>&nbsp;&#187;&nbsp;unix-process-thread
    <span class="updated">Updated&nbsp;
      2017-05-24 16:51
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">unix-process-thread</div>

  <h2 id="linux-javapython">Linux下查看 Java/Python 进程线程</h2>
<p>先使用 <code>ps -ef | grep [processname]</code> 查看进程id</p>
<h3 id="proc">进程文件proc</h3>
<p>查看status文件; <code>cat /proc/[pid]/status</code>;</p>
<h3 id="pstree">pstree</h3>
<p><code>pstree -p 7604</code></p>
<div class="hlcode"><pre><span></span>java(7604)─┬─{java}(7605)
           ├─{java}(7606)
           ├─{java}(7607)
           ├─{java}(7608)
           ├─{java}(7609)
           ├─{java}(7610)
           ├─{java}(7611)
           ├─{java}(7612)
           ├─{java}(7613)
           ├─{java}(7614)
           ├─{java}(7615)
           ├─{java}(7616)
           ├─{java}(7617)
           ├─{java}(7618)
           ├─{java}(7619)
           ├─{java}(7620)
           ├─{java}(7621)
           ├─{java}(7622)
           ├─{java}(7623)
           ├─{java}(7624)
           ├─{java}(7625)
           └─{java}(7626)
</pre></div>


<h3 id="top">top</h3>
<h3 id="ps">ps</h3>
<p><code>ps -eo ruser,pid,ppid,lwp,psr,args -L | grep java</code></p>
<h2 id="java">Java 进程线程堆栈分析工具</h2>
<h3 id="jps-jstack">jps &amp; jstack</h3>
<p><code>jps</code> 一般可以直接用来获取 java 进程 id; 比如我运行了一个8线程的java程序;jps命令格式 <code>jps [ options ] [ hostid ]</code><br />
主选项:</p>
<table>
<thead>
<tr>
<th align="center">选    项</th>
<th align="center">作            用</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-q</td>
<td align="center">只输出LVMID，省略主类的名称</td>
</tr>
<tr>
<td align="center">-m</td>
<td align="center">输出虚拟机进程启动时传递给主类main()函数的参数</td>
</tr>
<tr>
<td align="center">-l</td>
<td align="center">输出主类的全名，如果进程执行的是jar包，输出jar包路径</td>
</tr>
<tr>
<td align="center">-v</td>
<td align="center">输出虚拟机进程启动时的JVM参数</td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span></span>6993 org.eclipse.equinox.launcher_1.3.200.v20160318-1642.jar
7604 ThreadNums
15721 Jps
1372 Bootstrap
</pre></div>


<p>进程号是 7604;</p>
<p>jstack（Stack Trace for Java）命令用于生成<strong>虚拟机当前时刻的线程快照。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的目的主要是定位线程长时间出现停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等都是导致线程长时间停顿的原因。线程出现停顿的时候通过jstack来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做些什么事情，或者在等待些什么资源。</strong></p>
<p><code>sudo jstack [pid]</code> 查看 某个java进程的线程状态. 如果不反应, 使用强制参数 <code>sudo jstack -F [pid]</code>;可以直接查到各个线程的状态,运行到哪一句代码等.</p>
<div class="hlcode"><pre><span></span><span class="n">Attaching</span> <span class="n">to</span> <span class="n">process</span> <span class="n">ID</span> <span class="mi">7604</span><span class="o">,</span> <span class="n">please</span> <span class="n">wait</span><span class="o">...</span>
<span class="n">Debugger</span> <span class="n">attached</span> <span class="n">successfully</span><span class="o">.</span>
<span class="n">Server</span> <span class="n">compiler</span> <span class="n">detected</span><span class="o">.</span>
<span class="n">JVM</span> <span class="n">version</span> <span class="n">is</span> <span class="mf">25.131</span><span class="o">-</span><span class="n">b11</span>
<span class="n">Deadlock</span> <span class="n">Detection</span><span class="o">:</span>

<span class="n">No</span> <span class="n">deadlocks</span> <span class="n">found</span><span class="o">.</span>

<span class="n">Thread</span> <span class="mi">7626</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7625</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7624</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7623</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7622</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7621</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7620</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7619</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">IN_JAVA</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">21</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">20</span> <span class="o">(</span><span class="n">Compiled</span> <span class="n">frame</span><span class="o">;</span> <span class="n">information</span> <span class="n">may</span> <span class="n">be</span> <span class="n">imprecise</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7613</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLOCKED</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7612</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLOCKED</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">0</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">ReferenceQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">59</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">143</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">ReferenceQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">164</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">Finalizer$FinalizerThread</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">36</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">209</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7611</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLOCKED</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">0</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">.</span><span class="na">wait</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">502</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">Reference</span><span class="o">.</span><span class="na">tryHandlePending</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">54</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">191</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">Reference$ReferenceHandler</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">153</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>


<span class="n">Thread</span> <span class="mi">7605</span><span class="o">:</span> <span class="o">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLOCKED</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">0</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">38</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">1252</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">join</span><span class="o">()</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">1326</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">PrimeNumberConcurrencyAtomic</span><span class="o">.</span><span class="na">primeNumbers</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">atomic</span><span class="o">.</span><span class="na">AtomicLong</span><span class="o">,</span> <span class="kt">int</span><span class="o">,</span> <span class="kt">long</span><span class="o">)</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">65</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">45</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
 <span class="o">-</span> <span class="n">multicore</span><span class="o">.</span><span class="na">forkjoin</span><span class="o">.</span><span class="na">ThreadNums</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[])</span> <span class="nd">@bci</span><span class="o">=</span><span class="mi">19</span><span class="o">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">12</span> <span class="o">(</span><span class="n">Interpreted</span> <span class="n">frame</span><span class="o">)</span>
</pre></div>


<h3 id="jstat">jstat</h3>
<p>jstat 可以统计虚拟机状态参数信息.命令格式 <code>jstat [ option vmid [ interval [ s | ms ] [ count ] ] ]</code></p>
<h3 id="jmap">jmap</h3>
<p><code>sudo jmap -heap 7604</code> 可以查看JVM heap 参数.</p>
<h2 id="zombieorphan">僵尸进程(zombie)和孤儿进程(orphan)</h2>
<p>孤儿进程: 一个<strong>父进程提前退出, 但是子进程还在运行</strong>, 子进程成为孤儿进程. <strong>孤儿进程将被 init 进程(1号进程) 收养, 并由 init 进程对他们完成状态收集.</strong></p>
<p>僵尸进程: 父进程使用 <strong>fork 创建子进程, 如果子进程先退出</strong>, 而<strong>父进程并没有调用 wait或 waitpid 获取子进程状态信息.</strong></p>
<h2 id="_1">僵尸危害</h2>
<p>由于进程退出之后并不是释放所有的资源,内核保留一定的信息,如果进程不调用wait / waitpid的话， 那么保留的那段信息就不会释放，其进程号就会一直被占用，但是系统所能使用的进程号是有限的，如果大量的产生僵死进程，将因为没有可用的进程号而导致系统不能产生新的进程. 此即为僵尸进程的危害，应当避免。</p>
<h2 id="_2">查看僵尸进程个数</h2>
<p>查看僵尸进程</p>
<div class="hlcode"><pre><span></span>ps -ef | grep defunct | grep -v grep
</pre></div>


<p>统计僵尸个数</p>
<div class="hlcode"><pre><span></span>ps -ef | grep defunct | grep -v grep | wc -l
</pre></div>


<h2 id="_3">如何杀死僵尸进程</h2>
<p>僵尸进程很难用 kill 命令杀死.</p>
<h3 id="1">1.利用信号通信机制</h3>
<p>子进程退出时向父进程发送SIGCHILD信号，父进程处理SIGCHILD信号。在信号处理函数中调用wait进行处理僵尸进程。</p>
<div class="hlcode"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_child</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="c1">//创建捕捉子进程退出信号</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span><span class="n">sig_child</span><span class="p">);</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork error:&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I am child process,pid id %d.I am exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">getpid</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I am father process.I will sleep two seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="c1">//等待子进程先退出</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="c1">//输出进程信息</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;ps -o pid,ppid,state,tty,command&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;father process is exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_child</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span>
<span class="p">{</span>
     <span class="kt">pid_t</span>        <span class="n">pid</span><span class="p">;</span>
     <span class="kt">int</span>        <span class="n">stat</span><span class="p">;</span>
     <span class="c1">//处理僵尸进程</span>
     <span class="k">while</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">))</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;child %d terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h2 id="2-fork">2. fork 两次</h2>
<p>原理是将子进程成为孤儿进程，从而其的父进程变为init进程，通过init进程可以处理僵尸进程</p>
<div class="hlcode"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">pid_t</span>  <span class="n">pid</span><span class="p">;</span>
    <span class="c1">//创建第一个子进程</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork error:&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//第一个子进程</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//子进程再创建子进程</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I am the first child process.pid:%d</span><span class="se">\t</span><span class="s">ppid:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">getpid</span><span class="p">(),</span><span class="n">getppid</span><span class="p">());</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork error:&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//第一个子进程退出</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;first procee is exited.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//第二个子进程</span>
        <span class="c1">//睡眠3s保证第一个子进程退出，这样第二个子进程的父亲就是init进程里</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I am the second child process.pid: %d</span><span class="se">\t</span><span class="s">ppid:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">getpid</span><span class="p">(),</span><span class="n">getppid</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//父进程处理第一个子进程退出</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;waitepid error:&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2017 田奇.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2017-12-05 23:08:39</p>
      </span>
    </div>
  </body>
</html>