<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>ConcurrencyModel - MetaHacks Wiki</title>
    <meta name="keywords" content="wiki, simiki, computer, cognitive,"/>
    <meta name="description" content="my personal wiki"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#distributedsystem">distributedsystem</a>&nbsp;&#187;&nbsp;ConcurrencyModel
    <span class="updated">Updated&nbsp;
      2017-03-28 22:33
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">ConcurrencyModel</div>

  <h1 id="_1">并行计算</h1>
<p>两大类并行</p>
<h2 id="_2">多进程或多线程并行</h2>
<p>race condition dead lock</p>
<h2 id="_3">流水线并行</h2>
<p>non-blocking io event-driven system</p>
<h2 id="functional-parallelism">函数式并行(Functional Parallelism)</h2>
<p>单个任务可以被拆分成多个部分来处理，每个部分都是一个函数，数据经过这些函数的时候是并行处理的，其实就是流水线<br />
mapreduce; 但是对于本来就运行多个不同类型的任务的系统，比如 web server database server 都是不适合用函数式并行的，因为cpu本来就在处理多任务</p>
<h1 id="asignment1">Asignment1</h1>
<h2 id="1-sum-an-array-by-multi-threads">1. Sum An Array By Multi-Threads</h2>
<p>数组求和实验, 采用串行和多线程的形式进行比较.实验的测试代码:</p>
<div class="hlcode"><pre><span></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">400000</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">cpus</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="n">cpus</span><span class="o">/</span><span class="mi">4</span><span class="o">,</span> <span class="n">cpus</span><span class="o">/</span><span class="mi">2</span><span class="o">,</span> <span class="n">cpus</span><span class="o">,</span> <span class="n">cpus</span> <span class="o">+</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cpus</span><span class="o">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cpus</span><span class="o">+</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">cpus</span><span class="o">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">cpus</span><span class="o">};</span>
        <span class="kt">double</span><span class="o">[]</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">loops</span><span class="o">];</span>
        <span class="n">String</span> <span class="n">str0</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%20s\t%15d\t%15d\t%15d\t%15d\t%15d\t%15s\n&quot;</span><span class="o">,</span> <span class="s">&quot;Threads\\Loops&quot;</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="s">&quot;Average(ms)&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str0</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">cores</span> <span class="o">:</span> <span class="n">threads</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                    <span class="n">sum</span> <span class="o">=</span> <span class="n">ArraySumer</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">cores</span><span class="o">);</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                    <span class="n">ts</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
                    <span class="n">t</span> <span class="o">+=</span> <span class="n">ts</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>

                <span class="o">}</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">/</span> <span class="n">loops</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">str1</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%20s\t%15f\t%15f\t%15f\t%15f\t%15f\t%15f\n&quot;</span><span class="o">,</span> <span class="n">cores</span><span class="o">+</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">ts</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">ts</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">ts</span><span class="o">[</span><span class="mi">2</span><span class="o">],</span> <span class="n">ts</span><span class="o">[</span><span class="mi">3</span><span class="o">],</span> <span class="n">ts</span><span class="o">[</span><span class="mi">4</span><span class="o">],</span> <span class="n">t</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str1</span><span class="o">);</span>
            <span class="o">}</span>


        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>


<h3 id="11-one-thread-sequential">1.1 one thread (sequential)</h3>
<p>单线程就是一种串行求和, 设置 threadSize = 1即可!</p>
<h3 id="12-different-thread-nums-compares-parallel">1.2 different thread nums compares (parallel)</h3>
<p>本实验<strong>对每一种线程个数(Threads)做了五次实验(Loops=5), 然后求出五次的平均性能(Average).</strong></p>
<table>
<thead>
<tr>
<th align="right">Threads\Loops</th>
<th align="right">1</th>
<th align="right">2</th>
<th align="right">3</th>
<th align="right">4</th>
<th align="right">5</th>
<th align="right">Average(ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">1</td>
<td align="right">4.000000</td>
<td align="right">5.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">2.000000</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">0.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">0.000000</td>
<td align="right">0.200000</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">0.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">0.000000</td>
<td align="right">0.200000</td>
</tr>
<tr>
<td align="right">6</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">1.000000</td>
<td align="right">0.600000</td>
</tr>
<tr>
<td align="right">8</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.600000</td>
</tr>
<tr>
<td align="right">10</td>
<td align="right">1.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">5.000000</td>
<td align="right">1.600000</td>
</tr>
<tr>
<td align="right">12</td>
<td align="right">10.000000</td>
<td align="right">3.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">3.000000</td>
</tr>
<tr>
<td align="right">14</td>
<td align="right">1.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">0.600000</td>
</tr>
<tr>
<td align="right">16</td>
<td align="right">1.000000</td>
<td align="right">1.000000</td>
<td align="right">8.000000</td>
<td align="right">1.000000</td>
<td align="right">0.000000</td>
<td align="right">2.200000</td>
</tr>
</tbody>
</table>
<p>从以上实验结果可以看出, <strong>对于多线程求和, 线程数目并不是越多性能越好, 一般设置为可用处理器个数或者可用处理器个数的2倍性能最佳!</strong></p>
<h3 id="13-shared-and-local-memory-in-my-code">1.3 shared and local memory in my code</h3>
<p>以下是实验中使用的  <code>ArraySumer</code> 类的代码.</p>
<div class="hlcode"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArraySumer</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">a</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">low</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">high</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">low</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">high</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sum</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">threadSize</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">ArraySumer</span><span class="o">[]</span> <span class="n">as</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArraySumer</span><span class="o">[</span><span class="n">threadSize</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threadSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArraySumer</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span> <span class="n">i</span><span class="o">*</span><span class="n">len</span><span class="o">/</span><span class="n">threadSize</span><span class="o">,</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)*</span><span class="n">len</span><span class="o">/</span><span class="n">threadSize</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threadSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">result</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>从代码中可以看出, 所有线程共享数组变量 <code>a</code>. 主线程和从线程都只对 <code>a</code> 进行读取操作. 主线程通过局部变量的形式将参数 <code>low</code>, <code>high</code> 传递给从线程, 从线程会写入自己的成员变量 <code>result</code>, 而主线程会读取所有从线程的成员变量 <code>result</code>. 因此 race condition 可能会发生在这里, 但是这个数组求和程序, 由于从线程的 <code>as[i].join()</code> 操作, 主线程会等待所有的从线程都做完(写完 result)之后才开始读取, 因此并没有数据竞争.</p>
<h3 id="14-preformance-analysis">1.4 preformance analysis</h3>
<p><strong>对于多线程 parallel, 并不是选择越多的线程越好, 因为创建线程本身也是耗费资源(时间和空间资源)的.</strong> 极端的例子, 比如现在有处理器P个,P &gt;&gt; n, 我们对于每一个数,都创建一个线程读取, 然后让主线程合并, 这反而没有串行执行的快. </p>
<p><strong>因此要想使得多线程 performance 达到最大, 需要选取合适的 threadSize. 从以上的实验可以得出一个经验性的结论就是, 线程数目和当前可得处理器的个数有关系, 一般我们选取cpus或者 2*cpus比较合理.</strong></p>
<h2 id="2-divide-and-conquer-method-to-write-a-parallel-program-for-computing-the-max-number-of-an-array">2. Divide-and-Conquer method to write a parallel program for computing the max number of an array</h2>
<p>采用分治法计算数组的最大(最小)数, 分治思想: 主线程将任务分解成两个子任务, 左子线程寻找左半边数组的最大值, 右子线程寻找右半边数组的最大值, 当左右任务完成之后, 主线程合并左右结果(比较左右结果的较大者返回), 左右线程进行同样的递归分解操作, 分解终止的条件由 <code>SEQUENTIAL_CUTOFF</code> 来控制.</p>
<h3 id="21-startrun-method">2.1 start/run method</h3>
<p>根据分治思想, 代码如下:</p>
<div class="hlcode"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaxNumber</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">low</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">high</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">;</span>
    <span class="n">MaxNumber</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">,</span> <span class="kt">int</span> <span class="n">low</span><span class="o">,</span> <span class="kt">int</span> <span class="n">high</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cutoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">numbers</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">low</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">SEQUENTIAL_CUTOFF</span> <span class="o">=</span> <span class="n">cutoff</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">max</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">max</span><span class="o">,</span> <span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
            <span class="n">MaxNumber</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumber</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">low</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
            <span class="n">MaxNumber</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumber</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">high</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
            <span class="n">left</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">right</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
                <span class="n">right</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated catch block</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">max</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">max</span><span class="o">,</span> <span class="n">right</span><span class="o">.</span><span class="na">max</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">max</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cutoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">MaxNumber</span> <span class="n">mn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumber</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">numbers</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">cutoff</span><span class="o">);</span>
        <span class="n">mn</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">mn</span><span class="o">.</span><span class="na">max</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>采用覆盖<code>run()</code> 方法的缺陷就是无法返回一个值, 只能通过成员变量的形式存储. 另外, 由于每一次递归创建子任务的时候, 主线程没有做任何计算任务, 必须要等待左右都完成之后,才开始计算, 这是一种资源的浪费, 因此一种形式的优化是,让主线程来做右子树的任务! 这样线程数目可以减少一般!</p>
<div class="hlcode"><pre><span></span><span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
<span class="n">MaxNumber</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumber</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">low</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
<span class="n">MaxNumber</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumber</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">high</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
<span class="n">left</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="c1">//right.start();</span>
<span class="n">right</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="c1">//right.join();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODO Auto-generated catch block</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<h3 id="22-forkjoin-framework">2.2 Fork/Join framework</h3>
<p>以下是改用fork/join framework 的代码:</p>
<div class="hlcode"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaxNumberForkJoin</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">low</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">high</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">;</span>

    <span class="n">MaxNumberForkJoin</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">,</span> <span class="kt">int</span> <span class="n">low</span><span class="o">,</span> <span class="kt">int</span> <span class="n">high</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cutoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">numbers</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">low</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">SEQUENTIAL_CUTOFF</span> <span class="o">=</span> <span class="n">cutoff</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">max</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">max</span><span class="o">,</span> <span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">max</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
            <span class="n">MaxNumberForkJoin</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumberForkJoin</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">low</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
            <span class="n">MaxNumberForkJoin</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxNumberForkJoin</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">high</span><span class="o">,</span> <span class="n">SEQUENTIAL_CUTOFF</span><span class="o">);</span>
            <span class="n">left</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">rightMax</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="na">compute</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">leftMax</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">max</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">rightMax</span><span class="o">,</span> <span class="n">leftMax</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">max</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="n">ForkJoinPool</span> <span class="n">fjPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">max</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cutoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fjPool</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">new</span> <span class="n">MaxNumberForkJoin</span><span class="o">(</span><span class="n">numbers</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">numbers</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">cutoff</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h3 id="23-sequential-checker">2.3 sequential checker</h3>
<p>以下是串行运算的部分代码:</p>
<div class="hlcode"><pre><span></span>for (int i = 0; i &lt; size; i++) {
    max = Math.max(max, numbers[i]);
}
</pre></div>


<h3 id="24-performance-comparison">2.4 performance comparison</h3>
<p>这里, 我设置的 <code>SEQUENTIAL_CUTOFF</code> 的值是 2048; 还是一样, 对于每一种情况(Serialize Start/Run 和 Fork/Join) 都采用五次测试取平均来比较平均时间性能. 数组规模是 2^25 次方.</p>
<table>
<thead>
<tr>
<th align="right">Pattern\Loops</th>
<th align="right">1</th>
<th align="right">2</th>
<th align="right">3</th>
<th align="right">4</th>
<th align="right">5</th>
<th align="right">Average(ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">Serialize Baseline</td>
<td align="right">29.673285</td>
<td align="right">30.963514</td>
<td align="right">26.244178</td>
<td align="right">26.037493</td>
<td align="right">25.921920</td>
<td align="right">27.768078</td>
</tr>
<tr>
<td align="right">Parallelize Start/Run</td>
<td align="right">13103.625879</td>
<td align="right">9753.860262</td>
<td align="right">9774.133012</td>
<td align="right">10805.342403</td>
<td align="right">9349.867925</td>
<td align="right">10557.365896</td>
</tr>
<tr>
<td align="right">Parallelize Fork/Join</td>
<td align="right">34.131773</td>
<td align="right">20.526604</td>
<td align="right">15.806599</td>
<td align="right">10.757907</td>
<td align="right">10.060238</td>
<td align="right">18.256624</td>
</tr>
</tbody>
</table>
<p>对于2^26 次方的时候, Start/Run 模式会出现 <code>Exception in thread "Thread-28661" java.lang.OutOfMemoryError: unable to create new native thread</code> 这种 <code>OutOfMemory</code> 的错误. 但是 Fork/Join 可以轻松应对! </p>
<p><strong>猜测 Fork/Join framework 内部实现了线程池, 因此可以保证不会因为创建过多线程而导致 JVM 爆出内存错误. 因为每一个线程都有私有线程栈, 线程创建的越多, 需要的内存就越多, 当内存不够的时候, 就无法再创建线程了! </strong></p>
<p>这里<strong>要么设置更小的线程栈以争取创建更多线程的可能, 要么扩充JVM内存.</strong> 但是栈大小本身 JVM 也是有限制的, 设置过小, JVM 就无法启动而报错!</p>
<div class="hlcode"><pre><span></span>The stack size specified is too small, Specify at least 228k
Error: Could not create the Java Virtual Machine.
Error: A fatal exception has occurred. Program will exit.
</pre></div>


<p><strong>但是当线程数数目达到一定程度的时候, 创建线程的开销反而大于任务本身了, 这是适得其反的! 另外, 线程栈过小的话, 如果有递归, 这里分治法就是递归, 压栈就不可能很深, 就会限制递归的深度, 限制递归的深度就会限制能解决问题的规模数目!</strong></p>
<p>去掉 Start/Run 方法之后, 我们设置数组规模到JVM堆可以容纳的最大值, <strong>运行的时候你可以设置JVM 的运行参数 <code>-Xmx4096M -Xms2000M -Xmn500M</code>, 因为JVM默认最大堆内存是机器物理内存的 1/4, 而我机器内存8G, 也就是最大是2G, 但是JVM最大堆内存的限制实际上取决于操作系统和物理内存空间, 我的机器最大堆内存可以设置到8G. </strong></p>
<div class="hlcode"><pre><span></span>             Pattern\Loops                1               2               3               4               5     Average(ms)
        Serialize Baseline       188.076303      206.252412      208.105703      203.449220      203.056148      201.787957
     Parallelize Fork/Join       145.812311       85.910176       85.791367       90.719006       81.187196       97.884011
</pre></div>


<p>但是<strong>你最好不要设置成最大内存 8G, 除非你的服务器只运行一个 JAVA 程序, 如果你设置成最大物理内存8 G, 然后申请 1&lt;&lt;30 个int整形数组,也即是占用 4G 内存, 然后运行程序,机器会非常卡, 因为处理器和内存资源全部都给 JAVA 程序了, 其他进程就无法很愉快的运行和响应了! 如果设置的 <code>SEQUENTIAL_CUTOFF</code> 和数组规模以及处理器个数不太符合的话,由于线程数目过多, Fork/Join 的性能就比不上 Serialize 了.</strong> <code>SEQUENTIAL_CUTOFF = 1&lt;&lt;11</code>, 将得到一下结果;</p>
<div class="hlcode"><pre><span></span>             Pattern\Loops                1               2               3               4               5     Average(ms)
        Serialize Baseline       952.887980     1345.387388      777.596211      773.802849      774.879831      924.910852
     Parallelize Fork/Join      3157.547799     1058.703371     2999.615653      274.054247      245.031633     1546.990541
</pre></div>


<p>因此, 我再次提升 <code>SEQUENTIAL_CUTOFF = 1&lt;&lt;15</code>, 此时 Fork/Join 的性能将会更好.</p>
<div class="hlcode"><pre><span></span>             Pattern\Loops                1               2               3               4               5     Average(ms)
        Serialize Baseline       781.488606      794.344170      761.915751      750.881256      746.211944      766.968345
     Parallelize Fork/Join       398.081041      257.000682      215.312012      228.940126      233.489181      266.564608
</pre></div>


<h2 id="4-primenumber-by-concurrency-and-parallel">4. PrimeNumber By Concurrency And Parallel</h2>
<h3 id="41-parallel">4.1 Parallel</h3>
<div class="hlcode"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrimeNumberParallel</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">low</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">high</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">;</span> <span class="c1">// 使用 vector 线程安全的</span>

    <span class="n">PrimeNumberParallel</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">low</span><span class="o">,</span> <span class="kt">int</span> <span class="n">high</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">primes</span> <span class="o">=</span> <span class="n">primes</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">low</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isPrime</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">primes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="c1">//              System.out.println(i);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">long</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">number</span><span class="o">);</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">primeNumbers</span><span class="o">(</span><span class="kt">int</span> <span class="n">threads</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="n">PrimeNumberParallel</span><span class="o">[]</span> <span class="n">pns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrimeNumberParallel</span><span class="o">[</span><span class="n">threads</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrimeNumberParallel</span><span class="o">(</span><span class="n">primes</span><span class="o">,</span> <span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="o">/</span><span class="n">threads</span><span class="o">,</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)*</span><span class="n">size</span><span class="o">/</span><span class="n">threads</span><span class="o">);</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">primes</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="42-concurrency">4.2 Concurrency</h3>
<div class="hlcode"><pre><span></span><span class="c1">// concurrency for prime</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrimeNumberConcurrency</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>

    <span class="n">Counter</span> <span class="n">counter</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">;</span> <span class="c1">// 使用 vector 线程安全的</span>

    <span class="n">PrimeNumberConcurrency</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">,</span> <span class="n">Counter</span> <span class="n">counter</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">primes</span> <span class="o">=</span> <span class="n">primes</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">number</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">number</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="n">SIZE</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isPrime</span><span class="o">(</span><span class="n">number</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">primes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
<span class="c1">//              System.out.println(number);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">long</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">number</span><span class="o">);</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">primeNumbers</span><span class="o">(</span><span class="n">Counter</span> <span class="n">counter</span><span class="o">,</span> <span class="kt">int</span> <span class="n">threads</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">primes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="n">PrimeNumberConcurrency</span><span class="o">[]</span> <span class="n">pns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrimeNumberConcurrency</span><span class="o">[</span><span class="n">threads</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrimeNumberConcurrency</span><span class="o">(</span><span class="n">primes</span><span class="o">,</span> <span class="n">counter</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">pns</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">primes</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="43-primenumber-concurrency-and-parallel-perfomance-comparison">4.3 PrimeNumber concurrency and parallel perfomance comparison</h3>
<div class="hlcode"><pre><span></span><span class="o">/</span> <span class="n">better</span><span class="o">:</span> <span class="k">do</span>
<span class="n">SumThread</span> <span class="n">left</span>  <span class="o">=</span> <span class="err">…</span>
<span class="n">SumThread</span> <span class="n">right</span> <span class="o">=</span> <span class="err">…</span>
<span class="c1">// order of next 4 lines</span>
<span class="c1">// essential – why?</span>
<span class="n">left</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="n">right</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> 
<span class="n">ans</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="na">ans</span><span class="o">+</span><span class="n">right</span><span class="o">.</span><span class="na">ans</span><span class="o">;</span>
</pre></div>


<div class="hlcode"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">padRight</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%1$-&quot;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s">&quot;s&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>  
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">padLeft</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%1$&quot;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s">&quot;s&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>  
<span class="o">}</span>

<span class="o">...</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
 <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">padRight</span><span class="o">(</span><span class="s">&quot;Howto&quot;</span><span class="o">,</span> <span class="mi">20</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span><span class="o">);</span>
 <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">padLeft</span><span class="o">(</span><span class="s">&quot;Howto&quot;</span><span class="o">,</span> <span class="mi">20</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2017 田奇.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2017-07-29 19:02:45</p>
      </span>
    </div>
  </body>
</html>