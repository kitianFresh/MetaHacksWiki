<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>python-metaclass - MetaHacks Wiki</title>
    <meta name="keywords" content="wiki, simiki, computer, cognitive,"/>
    <meta name="description" content="my personal wiki"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#python">python</a>&nbsp;&#187;&nbsp;python-metaclass
    <span class="updated">Updated&nbsp;
      2017-12-07 23:37
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">python-metaclass</div>

  <div class="hlcode"><pre><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__module__</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>


<div class="hlcode"><pre><span class="nd">@debug</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;***&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="o">***</span><span class="n">add</span>





<span class="mi">4</span>
</pre></div>


<p>Debug一个类的所有实例方法</p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">debugmethods</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">debug</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cls</span>
</pre></div>


<div class="hlcode"><pre><span class="nd">@debugmethods</span>
<span class="k">class</span> <span class="nc">Spam</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">grok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gun</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fire</span><span class="p">():</span>
        <span class="k">pass</span>
</pre></div>


<div class="hlcode"><pre><span class="nx">grok</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">grok</span> <span class="nx">at</span> <span class="mh">0x10ed6c050</span><span class="o">&gt;</span>
<span class="nx">bar</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">bar</span> <span class="nx">at</span> <span class="mh">0x10ed6c0c8</span><span class="o">&gt;</span>
<span class="nx">foo</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">foo</span> <span class="nx">at</span> <span class="mh">0x10ed6c140</span><span class="o">&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">vars</span><span class="p">(</span><span class="n">Spam</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="c"># Spam.__dict__.items()</span>
</pre></div>


<div class="hlcode"><pre><span class="cp">[</span><span class="p">(</span><span class="s1">&#39;grok&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">function</span> <span class="nx">__main__.grok</span><span class="o">&gt;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="s1">&#39;__main__&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">function</span> <span class="nx">__main__.bar</span><span class="o">&gt;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;fire&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">staticmethod</span> <span class="nx">at</span> <span class="mh">0x10ece4b78</span><span class="o">&gt;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;gun&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">classmethod</span> <span class="nx">at</span> <span class="mh">0x10ece4980</span><span class="o">&gt;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">function</span> <span class="nx">__main__.foo</span><span class="o">&gt;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="cp">]</span>
</pre></div>


<p>以上缺点就是并不能装饰classmethod和staticmethod，为什么呢？从打印来看，你会发现函数地址不在一个scope下</p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">debugattr</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="n">orig_getattribute</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__getattribute__</span> 
    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Get:&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orig_getattribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">cls</span><span class="o">.</span><span class="n">__getattribute__</span> <span class="o">=</span> <span class="n">__getattribute__</span>

    <span class="k">return</span> <span class="n">cls</span>
</pre></div>


<div class="hlcode"><pre><span class="nd">@debugattr</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="c">#Python2.7中一定要继承object，否则没有object的一些属性</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">x</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="p">(</span><span class="err">&#39;</span><span class="n">Get</span><span class="o">:</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span>





<span class="p">[</span><span class="err">&#39;</span><span class="n">__class__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__delattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dict__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__doc__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__format__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__getattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__getattribute__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__hash__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__init__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__module__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__new__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce_ex__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__repr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__setattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__sizeof__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__str__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasshook__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__weakref__</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>解决办法metaclass</p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">debugmeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">):</span>
        <span class="n">clsobj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">debugmeta</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">)</span>
        <span class="n">clsobj</span> <span class="o">=</span> <span class="n">debugmethods</span><span class="p">(</span><span class="n">clsobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clsobj</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># python 3 syntax</span>
<span class="sd">class Base(metaclass=debugmeta):</span>
<span class="sd">    pass</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">debugmeta</span>
</pre></div>


<div class="hlcode"><pre><span class="n">__metaclass__</span> <span class="o">&lt;</span><span class="n">class</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="p">.</span><span class="n">debugmeta</span><span class="err">&#39;</span><span class="o">&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">isinstance</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">debugmeta</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="p">[</span><span class="err">&#39;</span><span class="n">__abstractmethods__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__base__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__bases__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__basicsize__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__call__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__class__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__delattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dict__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dictoffset__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__doc__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__eq__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__flags__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__format__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__ge__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__getattribute__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__gt__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__hash__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__init__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__instancecheck__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__itemsize__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__le__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__lt__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__module__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__mro__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__name__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__ne__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__new__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce_ex__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__repr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__setattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__sizeof__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__str__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasscheck__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasses__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasshook__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__weakrefoffset__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">mro</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<div class="hlcode"><pre><span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;I&#39;m Spam.bar&quot;</span>
</pre></div>


<div class="hlcode"><pre><span class="nx">bar</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">bar</span> <span class="nx">at</span> <span class="mh">0x1083532a8</span><span class="o">&gt;</span>
<span class="nx">__init__</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">__init__</span> <span class="nx">at</span> <span class="mh">0x1083539b0</span><span class="o">&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">dir</span><span class="p">(</span><span class="n">Spam</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="p">[</span><span class="err">&#39;</span><span class="n">__class__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__delattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dict__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__doc__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__format__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__getattribute__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__hash__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__init__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__metaclass__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__module__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__new__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce_ex__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__repr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__setattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__sizeof__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__str__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasshook__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__weakref__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<div class="hlcode"><pre><span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    def __init__(self, name):</span>
<span class="s">        self.name = name</span>
<span class="s">    def bar(self):</span>
<span class="s">        print &quot;I&#39;m Spam.bar&quot;</span>
<span class="s">&#39;&#39;&#39;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">clsdict</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__prepare__</span><span class="p">(</span><span class="s">&#39;Spam&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Base</span><span class="p">,))</span>
</pre></div>


<div class="hlcode"><pre><span class="o">---------------------------------------------------------------------------</span>

<span class="nx">AttributeError</span>                            <span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="nx">ipython</span><span class="na">-input</span><span class="o">-</span><span class="mi">108</span><span class="na">-cf797e00aba3</span><span class="o">&gt;</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">clsdict</span> <span class="o">=</span> <span class="k">type</span><span class="bp">.</span><span class="nx">__prepare__</span><span class="p">(</span><span class="s1">&#39;Spam&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">Base</span><span class="p">,))</span>


<span class="nx">AttributeError</span><span class="p">:</span> <span class="k">type</span> <span class="nb">object</span> <span class="s1">&#39;type&#39;</span> <span class="nx">has</span> <span class="nx">no</span> <span class="nx">attribute</span> <span class="s1">&#39;__prepare__&#39;</span>
</pre></div>


<p>注意，Python 2 中， type 并未实现 <code>__prepare__()</code> 方法。在 Python 3 中， type 实现了 <code>__prepare__()</code> 方法。 Python 解释器构造类的时候，在解析class body 之前，会调用<code>__prepare__()</code>函数。并且Python 解释器在调用 <code>__prepare__()</code> 之前总是先检查<code>__prepare__()</code> 的存在。 存在就会调用，不存在就返回一个一般的dict。</p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">prepare_class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">bases</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">metaclass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">metaclass</span> <span class="o">=</span> <span class="n">compute_default_metaclass</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>
    <span class="n">prepare</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metaclass</span><span class="p">,</span> <span class="s">&#39;__prepare__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prepare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prepare</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>


<blockquote>
<p><strong>prepare</strong> returns a dictionary-like object which is used to store the class member definitions during evaluation of the class body. In other words, the class body is evaluated as a function block (just like it is now), except that the local variables dictionary is replaced by the dictionary returned from <strong>prepare</strong>. This dictionary object can be a regular dictionary or a custom mapping type.</p>
</blockquote>
<p><code>__prepare__</code> 函数返回一个类词典对象用来存储在解析class body 期间发现的类成员定义。局部变量词典会被该方法返回的词典替换。参考<a href="https://www.python.org/dev/peps/pep-3115/?cm_mc_uid=16088229483114992455164&amp;cm_mc_sid_50200000=1503827755">PEP 3115 -- Metaclasses in Python 3000</a></p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">MyInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;I am a new int:)&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyInt</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="n">MyInt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span>
</pre></div>


<div class="hlcode"><pre><span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">new</span> <span class="kt">int</span><span class="o">:</span><span class="p">)</span>
<span class="mi">5</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">MyInt</span><span class="p">),</span><span class="nb">type</span><span class="p">(</span><span class="nb">tuple</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="p">(</span><span class="n">__main__</span><span class="p">.</span><span class="n">MyInt</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">dir</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="p">[</span><span class="err">&#39;</span><span class="n">__abstractmethods__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__base__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__bases__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__basicsize__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__call__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__class__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__delattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dict__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__dictoffset__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__doc__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__eq__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__flags__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__format__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__ge__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__getattribute__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__gt__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__hash__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__init__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__instancecheck__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__itemsize__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__le__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__lt__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__module__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__mro__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__name__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__ne__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__new__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__reduce_ex__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__repr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__setattr__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__sizeof__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__str__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasscheck__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasses__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__subclasshook__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">__weakrefoffset__</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">mro</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<div class="hlcode"><pre><span class="k">class</span> <span class="nc">InterfaceMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="c"># create a class_id if it&#39;s not specified</span>
        <span class="k">if</span> <span class="s">&#39;class_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="s">&#39;class_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c"># open the specified file for writing</span>
        <span class="k">if</span> <span class="s">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">dct</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="c"># we need to call type.__new__ to complete the initialization</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">InterfaceMeta</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">Interface</span> <span class="o">=</span> <span class="n">InterfaceMeta</span><span class="p">(</span><span class="s">&#39;Interface&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s">&#39;tmp.txt&#39;</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">Interface</span><span class="o">.</span><span class="n">class_id</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Interface</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">interface</span>
<span class="o">&lt;</span><span class="n">open</span> <span class="n">file</span> <span class="err">&#39;</span><span class="n">tmp</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="sc">&#39;w&#39;</span> <span class="n">at</span> <span class="mh">0x10ed49150</span><span class="o">&gt;</span>
</pre></div>


<p>每次都这样构造出一个新类会非常心累，因此和 装饰器一样 Python 又为我们提供了 语法糖。定义一个 有<code>__metaclass__</code> 属性的类，该类的构造自动会使用该 <code>__metaclass__</code> 指向的元类来构造。简化和方便了我们写代码；</p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">Interface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">InterfaceMeta</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="s">&#39;tmp.txt&#39;</span>

<span class="k">print</span><span class="p">(</span><span class="n">Interface</span><span class="o">.</span><span class="n">class_id</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Interface</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">interface</span>
<span class="o">&lt;</span><span class="n">open</span> <span class="n">file</span> <span class="err">&#39;</span><span class="n">tmp</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="sc">&#39;w&#39;</span> <span class="n">at</span> <span class="mh">0x10ed49270</span><span class="o">&gt;</span>
</pre></div>


<p>继承的子类也会只要元类未被修改，都会通过该元类来构造出来。</p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">UserInterface</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="s">&#39;foo.txt&#39;</span>

<span class="k">print</span><span class="p">(</span><span class="n">UserInterface</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">UserInterface</span><span class="o">.</span><span class="n">class_id</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="o">&lt;</span><span class="n">open</span> <span class="n">file</span> <span class="err">&#39;</span><span class="n">foo</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="sc">&#39;w&#39;</span> <span class="n">at</span> <span class="mh">0x10ed490c0</span><span class="o">&gt;</span>
<span class="n">userinterface</span>
</pre></div>


<h1 id="abstract-base-classabc">Abstract Base Class(ABC)</h1>
<p>抽象基类ABC，主要定义了基本类和最基本的抽象方法，为子类提供共有API。这个abc 包下有一个 abc.ABCMeta, 我们已经知道了元类，又知道了ABC是抽象基类，那这个 ABCMeta 就是创建 ABC 抽象基类的元类了。抽象基类一般不实现具体方法。都是定义的抽象方法和属性: <code>@abstractmethod</code> 和 <code>@abstarctproperty</code>.</p>
<p>抽象基类当然是用来继承的，这里的继承分两种：直接代码上的继承和将其他类注册为虚拟子类的继承方式。区别就是，直接继承，必须要实现抽象方法；而通过注册(register) 是可以不实现抽象方法的，但是还是会被认为是该ABC的子类，可以使用 issubclass 和 issubinstance 验证。</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span>

<span class="k">class</span> <span class="nc">MyABC</span><span class="p">():</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>
    <span class="k">pass</span>

<span class="n">MyABC</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">MyABC</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">((),</span> <span class="n">MyABC</span><span class="p">)</span>
</pre></div>


<p>以下是 issubclass 和 isinstance 的真正调用函数 <code>__instancecheck__</code> 和 <code>__subclasscheck__</code></p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">ABCMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__instancecheck__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement isinstance(inst, cls).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__subclasscheck__</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">),</span> <span class="n">inst</span><span class="o">.</span><span class="n">__class__</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">__subclasscheck__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement issubclass(sub, cls).&quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;__subclass__&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="p">{</span><span class="n">cls</span><span class="p">}</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span>
</pre></div>


<p>更多详细内容可以参考<a href="https://www.python.org/dev/peps/pep-3119/?cm_mc_uid=16088229483114992455164&amp;cm_mc_sid_50200000=1503827755">PEP 3119</a></p>
<h1 id="sixpython-2-3-six">six（python 2 * 3 = six）</h1>
<p>six 其实就是一个 Python 2 和 Python 3 的使用元类写法的兼容库。Python 2 中元类的使用通过 <code>__metaclass__</code>, Python 3 中是通过参数的形式 Class(Base1, Base2, metaclass=ABCMeta) 完成的。</p>
<p>装饰器是给一个类添加元类的23兼容写法。<code>@six.add_metaclass(metaclass)</code></p>
<div class="hlcode"><pre><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">Meta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">That</span> <span class="n">code</span> <span class="n">produces</span> <span class="n">a</span> <span class="k">class</span> <span class="nc">equivalent</span> <span class="n">to</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">on</span> <span class="n">Python</span> <span class="mi">3</span> <span class="ow">or</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">MyMeta</span>
<span class="n">on</span> <span class="n">Python</span> <span class="mf">2.</span>

<span class="n">Note</span> <span class="n">that</span> <span class="k">class</span> <span class="nc">decorators</span> <span class="n">require</span> <span class="n">Python</span> <span class="mf">2.6</span><span class="o">.</span> 

<span class="n">However</span><span class="p">,</span> <span class="n">the</span> <span class="n">effect</span> <span class="n">of</span> <span class="n">the</span> <span class="n">decorator</span> <span class="n">can</span> <span class="n">be</span> <span class="n">emulated</span> <span class="n">on</span> <span class="n">Python</span> <span class="mf">2.5</span> <span class="n">like</span> <span class="n">so</span><span class="p">:</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">MyClass</span> <span class="o">=</span> <span class="n">add_metaclass</span><span class="p">(</span><span class="n">Meta</span><span class="p">)(</span><span class="n">MyClass</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2018 田奇.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2018-01-22 22:59:48</p>
      </span>
    </div>
  </body>
</html>